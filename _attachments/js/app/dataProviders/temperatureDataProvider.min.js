TemperatureDataProvider=Class.create(DataProvider,{initialize:function($super,c,a){$super();var b=this;this.oDB=c;this.oOptions=$.extend({filter:"",},a);
if(typeof b.oOptions.view==="undefined"){throw"CouchDB view is not defined for dataprovider. This is required.Add it with oOptions.view = 'viewname'";}if(typeof b.oOptions.sensor_id==="undefined"){throw'The temperature requires a device when initialized. Add it to the optionswith oOptions.sensor_id = "sensor_id"';
}$.couch.db(this.oDB.name).info({success:function(e){recentUpdateSeq=e.update_seq-2;var d={feed:"normal",since:recentUpdateSeq,filter:b.oOptions.filter,include_docs:true,dev:b.oOptions.sensor_id};
$.getJSON("/"+b.oDB.name+"/_changes?"+decodeURIComponent($.param(d)),function(f){if(f.results.length){oDoc=f.results.pop().doc;b.vOnNewNumberData(oDoc.temperature);
b.vOnNewGraphData({y:oDoc.temperature,x:Math.round(oDoc.time/1000)});b.vOnNewData(oDoc);b.vSetupChanges(f.last_seq);}});}});},vRequestGraphRangeData:function($super,c,a){$super(c);
var b=this;this.oDB.view(this.oOptions.view+"/time",{startkey:[this.oOptions.sensor_id,c.min],endkey:[this.oOptions.sensor_id,c.max],reduce:false,update_seq:true,success:function(d){$.each(d.rows,function(e,f){a({y:f.value.data.temperature,x:parseInt(f.key[1]/1000,10)});
});}});},vRequestRangeData:function($super,c,a){$super(c);var b=this;this.oDB.view(this.oOptions.view+"/time",{startkey:[this.oOptions.sensor_id,c.min],endkey:[this.oOptions.sensor_id,c.max],reduce:false,update_seq:true,success:function(d){$.each(d.rows,function(e,f){a($.extend(true,f.value.data,{time:parseInt(f.key[1]/1000,10)}));
});}});},vOnNewDataReceive:function(b,a){a=a||this;if(typeof b!=="undefined"){a.vOnNewNumberData(b.results.slice(-1)[0].doc.temperature);$.each(b.results,function(c,d){if(typeof d.doc!=="undefined"&&typeof d.doc.time!=="undefined"){a.vOnNewData(d.doc);
a.vOnNewGraphData({y:d.doc.temperature,x:Math.round(d.doc.time/1000)});}});a.iLastChange=b.last_seq;a.vSetupChanges(b.last_seq);}},vSetupChanges:function(a){if(!this.bChangesRunning){this.oChangeHandler=this.oDB.changes(a,{include_docs:true,filter:this.oOptions.filter,dev:this.oOptions.sensor_id});
this.bChangesRunning=true;var b=this;this.oChangeHandler.onChange(function(c){b.vOnNewDataReceive(c,b);});}},vStop:function(){if(!$.isEmptyObject(this.oChangeHandler)){this.oChangeHandler.stop();
}}});